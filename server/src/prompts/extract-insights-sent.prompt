---
model: openai/gpt-4o-mini
config:
  temperature: 0.1
response_format:
  type: json_object
input:
  schema:
    type: object
    properties:
      emailContent: 
        type: string
        description: "The main content/body of the email"
      emailDate:
        type: string
        description: "The date this email was sent/received in YYYY-MM-DD format"
      todaysDate:
        type: string
        description: "Today's date in YYYY-MM-DD format for temporal context"
      emailMetadata:
        type: object
        properties:
          subject:
            type: string
            description: "Email subject line"
          sender:
            type: string
            description: "Full sender information (Name <email@domain.com>)"
          senderDomain:
            type: string
            description: "Domain of the sender (e.g., dropbox.com, amazon.com)"
          to:
            type: string
            description: "Recipients in To field"
          cc:
            type: string
            description: "Recipients in CC field"
          replyTo:
            type: string
            description: "Reply-To address if different from sender"
          threadId:
            type: string
            description: "Gmail thread ID for conversation context"
          emailType:
            type: string
            enum: ["inbox", "sent"]
            description: "Whether this was received or sent by the user"
        required: [subject, sender, senderDomain, emailType]
      userInfo:
        type: object
        properties:
          firstName:
            type: string
          lastName:
            type: string
          email:
            type: string
        required: [firstName, lastName, email]
    required: [emailContent, emailDate, todaysDate, emailMetadata, userInfo]
output:
  schema:
    type: object
    properties:
      inferences:
        type: array
        items:
          type: object
          properties:
            categories:
              type: array
              items:
                type: string
                enum: [basic, professional, personal, communication, behavioral, accounts, relationships, goals, style]
              description: "One or more relevant categories - insights can span multiple categories"
              maxItems: 3
              minItems: 1
            insight:
              type: string
              description: "Factual statement with confidence language and context awareness"
            confidence:
              type: number
              minimum: 0.5
              maximum: 1
              description: "Confidence level after reasoning about source, context, and plausibility"
            evidence:
              type: string
              description: "Direct quote or specific reference from the email"
            extractedOn:
              type: string
              description: "The email date for temporal context"
            reasoning:
              type: string
              description: "Brief explanation of why this confidence level was assigned"
          required: [categories, insight, confidence, evidence, extractedOn, reasoning]
    required: [inferences]
---
{{role "system"}}
You are an expert profile builder who extracts useful biographical insights from emails that users write to help AI assistants understand and serve people better.

{{role "user"}}
I need you to analyze this email that {{userInfo.firstName}} {{userInfo.lastName}} wrote and extract useful profile insights about them.

{{>email-direction-understanding}}

{{>user-identity-awareness userInfo=userInfo}}

{{>profile-mission userInfo=userInfo}}

<analysis_focus>
You're analyzing an email **FROM** {{userInfo.firstName}} to understand:
- **What they do** (work, projects, skills, roles)
- **Who they know** (relationships, contacts, connections)  
- **How they live** (interests, location, lifestyle, plans)
- **How they communicate** (style, preferences, patterns)
</analysis_focus>

<extraction_guidelines>
## WHAT TO EXTRACT

**Self-Disclosure (what they say about themselves):**
- "I work at..." → Professional role
- "I'm traveling to..." → Travel plans
- "I live in..." → Location information
- "I use..." → Tools and preferences

**Communication Patterns:**
- Email recipients → Who they communicate with
- Communication style → How they write and interact
- Language patterns → Their voice and tone

**Relationships:**
- Who they're emailing → Professional/personal contacts
- How they address people → Relationship dynamics
- Introductions they make → Their network connections

**Goals & Plans:**
- Future events they mention
- Projects they're working on
- Travel or life plans they share
</extraction_guidelines>

{{>extraction-principles}}

<automated_email_detection>
## AUTOMATED vs PERSONAL CONTENT:

❌ **Don't extract from automated/template emails:**
- Calendar notifications ("Event canceled", "Meeting scheduled")
- System-generated messages ("Password reset", "Account confirmation")  
- Service notifications ("Your order has shipped", "Payment processed")
- Template language ("To handle this...", "Click the link below")
- Standardized formatting that doesn't reflect personal voice

✅ **Only extract from genuine personal communication:**
- User's own words and thoughts
- Personal tone and authentic voice
- Custom messages they actually wrote
- Their own insights, opinions, plans they share
</automated_email_detection>

{{>multi-turn-conversation-analysis emailMetadata=emailMetadata}}

{{>relationship-extraction-rules emailDate=emailDate}}

{{>temporal-context emailDate=emailDate}}

---

<email_data>
**EMAIL WRITTEN BY {{userInfo.firstName}}:**

**Date:** {{emailDate}}
**To:** {{emailMetadata.to}}
**Subject:** {{emailMetadata.subject}}

**EMAIL CONTENT:**
{{emailContent}}
</email_data>

<task>
Extract useful profile insights that help understand {{userInfo.firstName}}'s professional life, personal interests, relationships, and communication style. 

**CRITICAL:** Only extract from genuine personal communication - ignore automated/template emails sent from their account.
</task> 