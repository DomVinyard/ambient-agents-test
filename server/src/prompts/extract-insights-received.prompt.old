---
model: openai/gpt-4o-mini
config:
  temperature: 0.1
response_format:
  type: json_object
input:
  schema:
    type: object
    properties:
      emailContent: 
        type: string
        description: "The main content/body of the email"
      emailDate:
        type: string
        description: "The date this email was sent/received in YYYY-MM-DD format"
      emailMetadata:
        type: object
        properties:
          subject:
            type: string
            description: "Email subject line"
          sender:
            type: string
            description: "Full sender information (Name <email@domain.com>)"
          senderDomain:
            type: string
            description: "Domain of the sender (e.g., dropbox.com, amazon.com)"
          to:
            type: string
            description: "Recipients in To field"
          cc:
            type: string
            description: "Recipients in CC field"
          replyTo:
            type: string
            description: "Reply-To address if different from sender"
          threadId:
            type: string
            description: "Gmail thread ID for conversation context"
          emailType:
            type: string
            enum: ["inbox", "sent"]
            description: "Whether this was received or sent by the user"
        required: [subject, sender, senderDomain, emailType]
    required: [emailContent, emailDate, emailMetadata]
output:
  schema:
    type: object
    properties:
      inferences:
        type: array
        items:
          type: object
          properties:
            categories:
              type: array
              items:
                type: string
                enum: [basic, professional, personal, communication, behavioral, accounts, relationships, goals, style]
              description: "One or more relevant categories - insights can span multiple categories"
              maxItems: 3
              minItems: 1
            insight:
              type: string
              description: "Factual statement with confidence language and context awareness"
            confidence:
              type: number
              minimum: 0.5
              maximum: 1
              description: "Confidence level after reasoning about source, context, and plausibility"
            evidence:
              type: string
              description: "Direct quote or specific reference from the email"
            extractedOn:
              type: string
              description: "The email date for temporal context"
            reasoning:
              type: string
              description: "Brief explanation of why this confidence level was assigned"
          required: [categories, insight, confidence, evidence, extractedOn, reasoning]
    required: [inferences]
---
user: |
  Extract PROFILE-WORTHY insights about the USER (email recipient) from this received email. Focus on standalone facts that would be useful in a personal profile, not temporary email details or transaction summaries.

  Email Date: {{emailDate}}
  
  **EMAIL METADATA:**
  Subject: {{emailMetadata.subject}}
  From: {{emailMetadata.sender}}
  To: {{emailMetadata.to}}
  {{#if emailMetadata.cc}}Cc: {{emailMetadata.cc}}{{/if}}
  {{#if emailMetadata.replyTo}}Reply-To: {{emailMetadata.replyTo}}{{/if}}
  Domain: {{emailMetadata.senderDomain}}
  Thread ID: {{emailMetadata.threadId}}
  Type: {{emailMetadata.emailType}}

  **EMAIL CONTENT:**
  {{emailContent}}

  ## EXTRACTION APPROACH:

  ### STEP 1: EXTRACT SPECIFIC NOUNS AND FACTS
  Scan the email for specific factual nouns and statements about the user:

  **HOUSING/LOCATION:**
  - Apartment complex names, building names, property names
  - Street addresses, neighborhoods, cities, states
  - Any location where the user lives or has lived

  **COMPANIES/EMPLOYERS:**
  - Company names where user works or worked
  - Job titles, departments, roles
  - Business names, organizations user is affiliated with

  **PEOPLE:**
  - Names of family members, friends, colleagues with specific identifiers (include email addresses when available)
  - Relationships (spouse, parent, manager, etc.) with full contact details
  - Anyone specifically connected to the user (prefer full name + email over generic first names)
  - **THREAD CONTEXT:** Same thread ID ({{emailMetadata.threadId}}) = same conversation - consider ongoing relationship context

  **SERVICES/ACCOUNTS:**
  - Names of services, platforms, apps user has accounts with
  - Banks, utilities, subscriptions, memberships
  - Any service provider that knows the user personally
  - **PAYMENT IS A STRONG PROFILE SIGNAL:** If user pays for something, that's highly valuable for understanding their priorities and usage patterns
  - Include meaningful attributes: paid vs free, premium vs basic, business vs personal

  **PERSONAL DETAILS:**
  - Names (full name, nicknames, preferred names)
  - Contact information (emails, phone numbers)
  - Ages, birthdates, personal identifiers

  ### STEP 2: ANALYZE SENDER-CONTENT RELATIONSHIPS
  Look for connections between who sent the email and what it contains. This is very important.

  - "Your team at [Property Name]" from housing service → User probably lives at that property
  - "From your [Department] team at [Company]" → User might work at that company
  - "Your [Service] representative at [Location]" → User uses that service/location
  
  **SENDER-CONTENT CONNECTIONS:**
  - Housing service + apartment complex name in signature → User's residence
  - Employer + office location mentioned → User's workplace
  - Bank + branch details → User's banking relationship
  - Service provider + account-specific details → User's service relationship
  
  **REJECT only if clearly fake:**
  - Random UUID strings or obviously auto-generated identifiers
  - Technical tracking data unrelated to user personally

  ### STEP 3: CONFIDENCE ASSIGNMENT
  Extract insights across confidence levels - don't only go for certainty:

  **85-100% confidence ("It is very likely that..."):**
  - Housing service mentions apartment complex name → User lives there
  - Employer mentions company name → User works there
  - Direct factual statements by appropriate sources

  **70-84% confidence ("It appears that..."):**
  - Service mentions user details in appropriate context
  - Clear business relationship implied by receiving emails
  - Reasonable factual information from credible sources

  **60-69% confidence ("We think..."):**
  - Plausible information from appropriate sources
  - Less direct but reasonable inferences

  **50-59% confidence ("It is possible that..."):**
  - Minimum confidence - still valuable to extract

  ### STEP 4: MARKETING EMAIL RESTRICTIONS
  **FOR PROMOTIONAL/MARKETING EMAILS - BE VERY RESTRICTIVE:**
  
  **✅ ONLY EXTRACT (accounts category):**
  - User receives emails from [Company] → User has account with that service
  - User gets service notifications → User uses that platform
  - **PAYMENT SIGNALS ARE ESPECIALLY VALUABLE:** If email mentions payment, billing, subscription renewal - extract this as paid service relationship
  
  **❌ NEVER INFER FROM PROMOTIONAL CONTENT:**
  - User interests based on what's being promoted (promotions ≠ interests)
  - User goals based on promotional invitations (invites ≠ intentions)
  - User preferences based on marketing offers (ads ≠ preferences)
  - Professional activities based on receiving promotions
  - Personal traits based on promotional targeting
  
  **EXAMPLE:** eBay promotion email → Extract "user has eBay account" (accounts), NOT "user interested in eBay Live events" (goals)

  ### STEP 5: PROFILE-WORTHY vs TEMPORARY DETAILS
  **✅ EXTRACT (durable, standalone profile facts):**
  - Service relationships with meaningful attributes (paid subscriptions, premium accounts, business vs personal)
  - **PAYMENT/BILLING RELATIONSHIPS ARE ESPECIALLY VALUABLE** - these show actual commitment and usage
  - Living locations (apartment complexes, neighborhoods, cities)
  - Employment details (companies, job titles, departments)
  - Behavioral patterns (financial habits, productivity methods)
  
  **❌ DON'T EXTRACT (temporary, email-specific details):**
  - "User's payment will be processed on 07/07/25" (temporary transaction)
  - "User's subscription costs GBP 49.99" (pricing detail)
  - "User does not need to take action" (temporary status, meaningless standalone)
  - "User's July charges have been posted" (temporary billing update)
  
  **✅ IMPORTANT: DO EXTRACT explicitly mentioned life events:**
  - Travel plans ("after we get back from England", "going to Paris")
  - Life changes ("moving to", "starting new job", "getting married")
  - Personal updates about user's circumstances and plans
  
  **TEST:** Would this insight make sense in a profile without knowing the email context? If no, don't extract it.

  ### STEP 6: FINAL QUALITY FILTERS
  **REJECT:**
  - Obviously auto-generated random data (UUID-like strings, random word combinations)
  - Technical tracking information not related to user personally
  - Information that contradicts common sense
  - Goals/interests inferred from promotional content

  **ACCEPT:**
  - Real addresses, apartment names mentioned by housing services
  - Company names mentioned by employers or colleagues  
  - Personal details shared by friends/family
  - Service relationships indicated by receiving legitimate communications

  **TRAVEL & LIFE EVENTS EXTRACTION:**
  - ✅ Email mentions user's upcoming travel plans → Extract destination and timing (**personal** + **goals**)
  - ✅ "We'll be back to visit after summer travels" → User has travel plans (**personal** + **goals**)
  - ✅ Service emails mentioning user's relocation → User is moving/has moved (**personal**)
  - ❌ Flight confirmations with times/gates → Specific logistics, not profile-worthy
  - ❌ Hotel booking confirmations → Transaction details, not profile-worthy

  **RELATIONSHIP EXTRACTION SPECIFICITY:**
  - ✅ "From: Sarah Chen <s.chen@acme.com>" + personal tone → User has personal relationship with Sarah Chen (s.chen@acme.com)
  - ❌ "Sarah" mentioned in email → Too general, unclear which Sarah
  - ✅ Sender signature: "John Smith, Account Manager" → User has business relationship with John Smith
  - ✅ Email from family member with recognizable email pattern → Family relationship with specific contact info
  - ❌ Generic first names without context → Not useful for profile building

  **CRITICAL: For relationships, ALWAYS include email addresses from headers:**
  - Extract sender as "Name <email@domain.com>" not just "Name"
  - If someone mentioned in content, include their full contact details when available
  - NEVER extract just "Robert" - always "Robert <email@domain.com>" or "Robert (context)"
  - Email addresses are essential for useful relationship tracking

  **IDENTIFY INTRODUCTION PATTERNS & CONNECTORS:**
  - Look for emails that are introductions: subject lines with "intro", "connecting", "meet"
  - Emails that introduce user to others or others to user
  - ✅ Email from Brianna introducing user to Robert → User has connection facilitated by Brianna
  - ✅ "I'd like to introduce you to..." → Extract relationship with introducer
  - Look for CC patterns in introduction emails to identify all participants

  ## CATEGORY DEFINITIONS:
  Use 1-3 categories per insight when the insight spans multiple areas:
  
  - **basic:** Name, age, contact information, personal identifiers
  - **professional:** Job, company, work projects, professional skills, work relationships
  - **personal:** Family, interests, hobbies, life events, travel plans, living location (exclude productivity tools and work apps)
  - **communication:** Contact preferences, communication style, availability patterns
  - **behavioral:** Habits, routines, work patterns, decision-making approaches, productivity tools usage, organization systems, payment patterns (what they spend money on)
  - **accounts:** Service accounts, platforms, subscriptions, financial services user has relationships with (include meaningful attributes like paid/free, premium/basic)
  - **relationships:** Named people with specific identifiers (name + email/contact info) and their relationship to the user
  - **goals:** Stated objectives, plans, aspirations, upcoming travel, future events, deadlines
  - **style:** Communication patterns, writing style, tone preferences, vernacular, language patterns user consistently exhibits
  
  **Examples of multi-category insights:**
  - Paid subscription → **accounts** + **behavioral** (service relationship + payment pattern)
  - Housing service relationship → **personal** + **accounts** (residence + service)
  - Work contact information → **professional** + **basic** (employment + identity)
  - Email from Robert <robert@example.com> → **relationships** (specific contact with full identifier)
  - Sender's communication style reveals patterns → **style** + **relationships** (how they communicate + who they are)

  **RELATIONSHIP EXTRACTION EXAMPLES:**
  - ✅ "User receives personal emails from Robert Johnson <robert.johnson@company.com>"
  - ❌ "User receives personal emails from Robert"
  - ✅ "User has business relationship with Sarah Chen <s.chen@acme.com>"
  - ❌ "User has business relationship with Sarah"
  - ✅ "User was connected to sender through introduction by Brianna Nelson <brianna@company.com>"
  - ❌ "User knows multiple people"

  **STYLE EXTRACTION EXAMPLES (from received emails):**
  - ✅ "User's contacts use formal communication style when writing to user (evidenced by formal greetings and structure)"
  - ✅ "User receives casual, friendly emails suggesting informal communication preferences"
  - ✅ "User's professional contacts use direct, brief communication style when corresponding"
  - ❌ "User prefers casual emails" (too inferential without direct evidence)

  ## OUTPUT REQUIREMENTS:

  Extract 0-8 PROFILE-WORTHY insights that tell us about the user as a person. Focus on durable facts that would be useful in a personal profile, not temporary transaction details or email-specific information.

  For each insight:
  ```
  insight: "[Confidence language] [specific fact] (as of {{emailDate}})"
  evidence: "[exact quote from email]"
  extractedOn: "{{emailDate}}"
  reasoning: "[Why this confidence level - source credibility, context appropriateness]"
  ```

  **CRITICAL:** Extract specific nouns as facts. If the email mentions an apartment complex name, extract it as where the user lives. If it mentions a company name as their workplace, extract it as their employer. Focus on concrete proper nouns, not abstract interpretations.

  Return only valid JSON. If no clear factual insights exist, return empty inferences array. 