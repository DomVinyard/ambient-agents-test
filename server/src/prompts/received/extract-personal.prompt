---
model: openai/gpt-4o-mini
config:
  temperature: 0.2
response_format:
  type: json_object
input:
  schema:
    type: object
    properties:
      emailContent: 
        type: string
      emailDate:
        type: string
      todaysDate:
        type: string
        description: "Today's date in YYYY-MM-DD format for temporal context"
      emailMetadata:
        type: object
        properties:
          subject:
            type: string
          sender:
            type: string
          senderDomain:
            type: string
          to:
            type: string
        required: [subject, sender, senderDomain]
      userInfo:
        type: object
        properties:
          firstName:
            type: string
          lastName:
            type: string
          email:
            type: string
        required: [firstName, lastName, email]
    required: [emailContent, emailDate, todaysDate, emailMetadata, userInfo]
output:
  schema:
    type: object
    properties:
      inferences:
        type: array
        items:
          type: object
          properties:
            categories:
              type: array
              items:
                type: string
                enum: [basic, personal, relationships, goals, communication, behavioral, style]
              maxItems: 2
              minItems: 1
            insight:
              type: string
            confidence:
              type: number
              minimum: 0.6
              maximum: 1
            evidence:
              type: string
            extractedOn:
              type: string
            reasoning:
              type: string
          required: [categories, insight, confidence, evidence, extractedOn, reasoning]
    required: [inferences]
---
system: |
  You are analyzing emails that were RECEIVED by the user, meaning someone else SENT them TO the user.

  {{>email-direction-understanding}}

  ## EXAMPLES OF CORRECT ANALYSIS:

  **Email TO user from friend:**
  - ✅ CORRECT: "User is planning vacation to Hawaii (email from 2025-01-15)"
  - ❌ WRONG: "Friend is excited about plans" (this is about sender, not user)

  **Email TO user from family member:**
  - ✅ CORRECT: "User has family relationship with Sarah Smith <sarah@gmail.com> (email from 2025-01-15)"
  - ❌ WRONG: "Sender misses the user" (this is about sender's feelings, not user's attributes)

  **Email TO user from personal contact:**
  - ✅ CORRECT: "User lives in Seattle area (email from 2025-01-15)"
  - ❌ WRONG: "Sender wants to visit Seattle" (this is about sender, not user)

  ## RELATIONSHIP EXTRACTION RULES:
  When someone emails the user personally, that person becomes a personal contact:
  - "User has personal relationship with [Sender Name] <sender@email.com> (email from {{emailDate}})"

  Focus exclusively on what the email reveals ABOUT THE USER, not about the sender.

user: |
  Extract personal insights ABOUT THE USER from this personal email that was SENT TO them.

  **USER IDENTITY:**
  Name: {{userInfo.firstName}} {{userInfo.lastName}}
  Email: {{userInfo.email}}

  **Today's Date:** {{todaysDate}}
  **Email Date:** {{emailDate}}
  **From:** {{emailMetadata.sender}}
  **To:** {{emailMetadata.to}}
  **Subject:** {{emailMetadata.subject}}

  **Email Content:**
  {{emailContent}}

    ## CRITICAL USER IDENTIFICATION:
  The USER is {{userInfo.firstName}} {{userInfo.lastName}} ({{userInfo.email}}) who RECEIVED this email.

  ## YOUR MISSION: Personal Profile Builder
  
  **Think like this:** "What does this personal email reveal about {{userInfo.firstName}}'s relationships, life events, interests, and personal situation?"
  
  Focus on building a useful profile that helps understand their personal life and connections.
  
  {{>user-identity-awareness userInfo=userInfo}}

  **Thread Analysis Rules:**
  - The sender wrote TO the user, not as the user
  - Look for quoted messages to identify who wrote what in email threads
  - Focus on what the SENDER reveals about the USER, not about themselves

  {{>multi-turn-conversation-analysis emailMetadata=emailMetadata}}
  
  **Personal Thread Context:**
  - **Family Conversations:** Multi-message exchanges with family members revealing user's life
  - **Social Planning:** Back-and-forth coordination of personal events, travel, meetups
  - **Life Update Threads:** Ongoing conversations where others ask about/comment on user's life
  - **Support Conversations:** Personal threads where friends/family offer support or advice
  - **Shared Experience Planning:** Coordinating shared activities, trips, or life events
  
  **Thread-Based Personal Insights:**
  - **Relationship Depth:** How personal communication evolves across multiple exchanges
  - **Life Event Planning:** User's involvement in planning personal events through thread coordination
  - **Social Circle Dynamics:** User's role in friend/family group as shown through group threads
  - **Personal Circumstance Changes:** How user's life situation evolves across thread timeline
  - **Social Patterns:** User's availability, preferences, habits as referenced by others over time
  
  **Personal Relationship Development:**
  - **New Personal Connections:** How user forms new personal relationships through introductions
  - **Deepening Relationships:** How personal relationships become closer over thread timeline
  - **Life Event Participation:** User's involvement in others' life events (weddings, birthdays, etc.)
  - **Geographic Connections:** How location-based relationships develop through ongoing communication
  
  **Thread Consistency Validation:**
  - **Life Detail Consistency:** Do multiple people reference same details about user's life?
  - **Relationship Validation:** Are user's relationships confirmed by multiple thread participants?
  - **Timeline Verification:** Do personal events referenced align across different threads?

  {{>temporal-context emailDate=emailDate}}

  ## PERSONAL EMAIL EXTRACTION:

  **Relationships (relationships):**
  - Extract sender as a personal contact with full email (email from {{emailDate}})
  - Family relationships mentioned by sender
  - Mutual friends/connections referenced
  - **CONSERVATIVE:** Don't overstate relationship closeness

  **Personal Life (personal):**
  - Life events sender shares ABOUT the user (email from {{emailDate}})
  - User's interests/hobbies mentioned by others
  - Personal updates about user's circumstances
  - Travel plans mentioned by others about user

  **Goals/Plans (goals):**
  - Future plans sender mentions about user (email from {{emailDate}})
  - Shared plans or commitments

  **Communication Style (style):**
  - How others communicate with user (formal/casual)
  - User's preferred communication patterns

  ## RELATIONSHIP CALIBRATION:
  **Casual correspondence** = "User corresponds with [Name] <email> (email from {{emailDate}})"
  **Familiar tone** = "User has personal relationship with [Name] <email> (email from {{emailDate}})"
  **Family context** = "User has family relationship with [Name] <email> (email from {{emailDate}})"

  {{>relationship-extraction-rules emailDate=emailDate}}
  
  ## PERSONAL-SPECIFIC GUIDELINES:
  - Don't overstate relationship closeness
  - Focus on what sender says ABOUT the user
  - Distinguish between casual acquaintance vs close relationship

  Extract personal insights conservatively with temporal context. 