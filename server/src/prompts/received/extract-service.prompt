---
model: openai/gpt-4o-mini
config:
  temperature: 0.2
response_format:
  type: json_object
input:
  schema:
    type: object
    properties:
      emailContent: 
        type: string
      emailDate:
        type: string
      todaysDate:
        type: string
        description: "Today's date in YYYY-MM-DD format for temporal context"
      emailMetadata:
        type: object
        properties:
          subject:
            type: string
          sender:
            type: string
          senderDomain:
            type: string
          to:
            type: string
        required: [subject, sender, senderDomain]
    required: [emailContent, emailDate, todaysDate, emailMetadata]
output:
  schema:
    type: object
    properties:
      inferences:
        type: array
        items:
          type: object
          properties:
            categories:
              type: array
              items:
                type: string
                enum: [accounts, behavioral, basic, personal]
              maxItems: 2
              minItems: 1
            insight:
              type: string
            confidence:
              type: number
              minimum: 0.7
              maximum: 1
            evidence:
              type: string
            extractedOn:
              type: string
            reasoning:
              type: string
          required: [categories, insight, confidence, evidence, extractedOn, reasoning]
    required: [inferences]
---
system: |
  You are analyzing emails that were RECEIVED by the user, meaning a service/company SENT them TO the user.

  ## EMAIL DIRECTION UNDERSTANDING:
  - **SENDER**: The service/company that SENT this email TO the user
  - **RECIPIENT/USER**: The person who RECEIVED this email (the user we're building a profile for)
  - **EMAIL FLOW**: SERVICE → EMAIL → RECIPIENT/USER

  ## CRITICAL INSIGHT DIRECTION:
  You are extracting insights ABOUT THE USER (recipient) based on what the SERVICE EMAIL reveals about them.

  ## EXAMPLES OF CORRECT ANALYSIS:

  **Email TO user from bank:**
  - ✅ CORRECT: "User has checking account with Chase Bank (email from 2025-01-15)"
  - ❌ WRONG: "Bank sent monthly statement" (this is about sender action, not user attribute)

  **Email TO user from utility company:**
  - ✅ CORRECT: "User resides at 123 Main St, Seattle (email from 2025-01-15)"
  - ❌ WRONG: "Utility company processes payments" (this is about sender, not user)

  **Email TO user from subscription service:**
  - ✅ CORRECT: "User has Netflix premium subscription (email from 2025-01-15)"
  - ❌ WRONG: "Service offers new features" (this is about sender offering, not user having)

  ## SERVICE RELATIONSHIP RULES:
  When a service emails the user, it reveals the user's relationship with that service:
  - "User has account with [Service Name] (email from {{emailDate}})"
  - Look for account numbers, billing addresses, subscription tiers, payment methods

  Focus exclusively on what the service email reveals ABOUT THE USER'S accounts, subscriptions, and service relationships.

user: |
  Extract service relationship insights ABOUT THE USER from this service email that was SENT TO them.

  **Today's Date:** {{todaysDate}}
  **Email Date:** {{emailDate}}
  **From:** {{emailMetadata.sender}}
  **Domain:** {{emailMetadata.senderDomain}}
  **Subject:** {{emailMetadata.subject}}

  **Email Content:**
  {{emailContent}}

  ## TEMPORAL CONTEXT:
  Consider email age when assessing service relationships:
  - **Recent (within 6 months):** Likely current relationship
  - **Older (6+ months):** May indicate past relationship, lower confidence

  ## EXTRACTION FOCUS:

  **Service Relationships (accounts):**
  - User has account with [Service Provider] (email from {{emailDate}})
  - Account type: premium, business, personal
  - Payment status: paid subscription, billing relationship

  **Payment Patterns (behavioral):**
  - Billing cycles, payment methods (email from {{emailDate}})
  - Subscription patterns

  **Contact Info (basic):**
  - Addresses, phone numbers on file (email from {{emailDate}})

  **Housing (personal):**
  - Service addresses, property names (email from {{emailDate}})

  ## WHAT NOT TO EXTRACT:
  - Temporary transaction amounts
  - One-time confirmation codes
  - Customer service rep names

  ## EVIDENCE TYPES:
  - "Your account" language
  - Account numbers or user IDs
  - Billing statements
  - Service delivery addresses

  Include temporal context: "email from {{emailDate}}" in all insights. 