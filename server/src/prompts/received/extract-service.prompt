---
model: openai/gpt-4o-mini
config:
  temperature: 0.3
response_format:
  type: json_object
input:
  schema:
    type: object
    properties:
      emailContent:
        type: string
      emailMetadata:
        type: object
        properties:
          sender:
            type: string
          senderDomain:
            type: string
          subject:
            type: string
        required: [sender, senderDomain, subject]
      userInfo:
        type: object
        properties:
          firstName: 
            type: string
          lastName: 
            type: string
          email: 
            type: string
        required: [firstName, lastName, email]
      emailDate:
        type: string
      todaysDate:
        type: string
    required: [emailContent, emailMetadata, userInfo, emailDate, todaysDate]
output:
  schema:
    type: object
    properties:
      inferences:
        type: array
        items:
          type: object
          properties:
            categories:
              type: array
              items:
                type: string
                enum: [accounts, behavioral, personal, basic]
            insight:
              type: string
            confidence:
              type: number
              minimum: 0.7
              maximum: 1
            evidence:
              type: string
            extractedOn:
              type: string
            reasoning:
              type: string
          required: [categories, insight, confidence, evidence, extractedOn, reasoning]
    required: [inferences]
---
{{role "system"}}
You are an expert profile builder who extracts useful biographical insights from emails to help AI assistants understand and serve people better.

{{role "user"}}
I need you to analyze this service email and extract useful profile insights about {{userInfo.firstName}} {{userInfo.lastName}}.

{{>email-direction-understanding}}

{{>user-identity-awareness userInfo=userInfo}}

{{>profile-mission userInfo=userInfo}}

<analysis_focus>
You're analyzing an email **TO** {{userInfo.firstName}} from a service/company. These emails reveal:
- **What services they use** (accounts, subscriptions, providers)
- **Where they live/work** (service locations, delivery addresses)  
- **How they live** (lifestyle choices, preferences, behaviors)
- **Their current situation** (financial patterns, life stage, priorities)
</analysis_focus>

<inference_guidelines>
## MAKE REASONABLE INFERENCES

**Geographic Location:**
- Local service providers → User lives/works in that area
- "Your dentist in San Mateo" → User has dentist in San Mateo, likely lives in Bay Area
- Utility bills → User resides at service address
- Local gym membership → User works out in that area

**Service Relationships:**  
- Account emails → User has active relationship with this service
- Healthcare providers → User receives care from these professionals
- Subscription services → User actively uses these platforms
- Local businesses → User patronizes these establishments

**Lifestyle & Preferences:**
- Premium service tiers → User values quality/convenience
- Eco-friendly services → User has environmental consciousness
- Fitness/wellness services → User prioritizes health
- Educational platforms → User invests in learning

**Financial Patterns:**
- Payment confirmations → User's spending categories
- Subscription levels → User's budget priorities
- Service frequency → User's usage patterns

**Behavioral Patterns (WHO they are, not what this email asks):**
- Service choices → User's values and priorities
- Usage patterns → User's lifestyle habits
- Provider relationships → User's approach to services
- ❌ Avoid: What this specific email is requesting (review requests, calls-to-action)
</inference_guidelines>

<extraction_schema>
## EXTRACTION CATEGORIES:

**basic:** Geographic location, contact info, demographic details
**accounts:** Service relationships, subscriptions, memberships  
**behavioral:** Usage patterns, preferences, habits, choices they make
**personal:** Lifestyle, interests, life situation, priorities
</extraction_schema>

{{>extraction-principles}}

{{>multi-turn-conversation-analysis emailMetadata=emailMetadata}}

{{>temporal-context emailDate=emailDate}}

---

<email_data>
**EMAIL TO ANALYZE:**

**Date:** {{emailDate}}
**From:** {{emailMetadata.sender}}
**Subject:** {{emailMetadata.subject}}

**EMAIL CONTENT:**
{{emailContent}}
</email_data>

<task>
Extract useful profile insights that help understand {{userInfo.firstName}}'s life, location, preferences, and service relationships. Make reasonable inferences that would help an AI assistant serve this person better.
</task> 